<!doctype html><html><head lang=zh-cn><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Vue响应式踩坑 - siaikin's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Vue响应式原理 Vue实现的响应式系统是基于Object.definedProperty()（还有一个类似的方法Object.defined"><meta property="og:image" content><meta property="og:title" content="Vue响应式踩坑"><meta property="og:description" content="Vue响应式原理 Vue实现的响应式系统是基于Object.definedProperty()（还有一个类似的方法Object.defined"><meta property="og:type" content="article"><meta property="og:url" content="https://siaikin.github.io/posts/vue%E5%93%8D%E5%BA%94%E5%BC%8F%E8%B8%A9%E5%9D%91/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-17T21:28:26+00:00"><meta property="article:modified_time" content="2019-08-17T21:28:26+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Vue响应式踩坑"><meta name=twitter:description content="Vue响应式原理 Vue实现的响应式系统是基于Object.definedProperty()（还有一个类似的方法Object.defined"><script src=https://siaikin.github.io/js/feather.min.js></script>
<link href=https://siaikin.github.io/css/fonts.11a1877508139eac0b5b4852ceb110c35641b3533321e66e39149e901ed5756b.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://siaikin.github.io/css/main.d902908ac6e0fab67957de5db5aea1b6455b19ae2ca98eac4c95a4a0fdc02238.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://siaikin.github.io/css/dark.c95c5dcf5f32f8b67bd36f7dab66680e068fce2b303087294114aabf7a7c080b.css disabled></head><body><div class=content><header><div class=main><a href=https://siaikin.github.io/>siaikin's Blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://siaikin.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Vue响应式踩坑</h1><div class=meta>Posted on Aug 17, 2019</div></div><section class=body><h1 id=vue响应式原理>Vue响应式原理</h1><p>Vue实现的响应式系统是基于<code>Object.definedProperty()</code>（还有一个类似的方法<code>Object.definedProperty()</code>，可以同时定义多个属性）的。</p><p><code>Object.definedProperty()</code>方法可以对一个对象中的属性定义<code>set</code>和<code>get</code>方法。</p><ol><li><code>get</code>方法在访问该属性时触发，返回值即访问该属性得到的值</li><li><code>set</code>方法在修改该属性值时触发</li></ol><p>Vue的实现方法是用<code>Object.definedProperty</code>将作为Vue中data选项的JavaScript对象里面定义的所有属性都<strong>转化</strong>为<code>getter/setter</code>。
我们可以把它当作在原来的JS对象里定义的所有属性外面包了一层壳（是属性外面不是JS对象外面），这层壳可以监听到外部对对象属性的访问（get）和设置（set）。</p><h6 id=关于gettersetter>关于<code>getter/setter</code></h6><p>在mdn文档中对其的解释如下：</p><blockquote><p>一个<code>getter</code>是一个获取某个特定属性的值的方法。一个<code>setter</code>是一个设定某个属性的值的方法。
你可以为预定义的或用户定义的对象定义<code>getter</code>和<code>setter</code>以支持新增的属性。
定义<code>getter</code>和<code>setter</code>的语法采用对象字面量语法。</p></blockquote><p>需要注意的是，如果在一个对象里已经用<code>get</code>关键字定义了一个<code>getter</code>那么在同一个对象里就不能再出现同名的属性，
同名的属性和<code>getter/setter</code>无法共存。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1</span><span><span style=color:#8a93a5;font-style:italic>// 错误写法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2</span><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#76a9f9>let</span> <span style=color:#aa89ea>obj</span> <span style=color:#54b1c7>=</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3</span><span>  <span style=color:#aa89ea>getterr</span><span style=color:#54b1c7>:</span> <span style=color:#98c379>&#39;getter&#39;</span><span style=color:#abb2bf>,</span>  <span style=color:#8a93a5;font-style:italic>// 同名属性
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">4</span><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#aa89ea>get</span> <span style=color:#aa89ea>getterr</span><span style=color:#abb2bf>()</span> <span style=color:#abb2bf>{</span>     <span style=color:#8a93a5;font-style:italic>// 同名getter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">5</span><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#76a9f9>return</span> <span style=color:#98c379>&#39;getter&#39;</span><span style=color:#abb2bf>;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">6</span><span>  <span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">7</span><span><span style=color:#abb2bf>};</span>
</span></span></code></pre></div><p>从不能有同名的属性和<code>getter/setter</code>这个特性我们可以看出上文的<strong>转化</strong>这个词的必要性，当然这Vue文档中的原文。
通过<strong>转化</strong>我们大致可以想象出Vue对响应式JS对象的处理过程。</p><ol><li>将data选项中的原始JS对象里面的所有属性重命名。将其转化为内部属性，比如<code>inner</code> -> <code>_inner</code>。</li><li>定义同属性名的<code>getter</code>和<code>setter</code>，因为之前的属性已经重命名了，所以这一步不会产生属性名的冲突。</li></ol><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1</span><span><span style=color:#8a93a5;font-style:italic>// 对一个对象简单的转化
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2</span><span><span style=color:#8a93a5;font-style:italic>// 将inner属性转化为`getter/setter`
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3</span><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#76a9f9>let</span> <span style=color:#aa89ea>obj</span> <span style=color:#54b1c7>=</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4</span><span>  <span style=color:#aa89ea>inner</span><span style=color:#54b1c7>:</span> <span style=color:#e5c07b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5</span><span><span style=color:#abb2bf>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7</span><span><span style=color:#76a9f9>let</span> <span style=color:#aa89ea>keys</span> <span style=color:#54b1c7>=</span> <span style=color:#e5c07b>Object</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>keys</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>obj</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8</span><span><span style=color:#76a9f9>for</span> <span style=color:#abb2bf>(</span><span style=color:#76a9f9>let</span> <span style=color:#aa89ea>i</span> <span style=color:#54b1c7>=</span> <span style=color:#d19a66>0</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>len</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>keys</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>length</span><span style=color:#abb2bf>;</span> <span style=color:#aa89ea>i</span> <span style=color:#54b1c7>&lt;</span> <span style=color:#aa89ea>len</span><span style=color:#abb2bf>;</span> <span style=color:#aa89ea>i</span><span style=color:#54b1c7>++</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9</span><span>  <span style=color:#76a9f9>let</span> <span style=color:#aa89ea>v</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>obj</span><span style=color:#abb2bf>[</span><span style=color:#aa89ea>keys</span><span style=color:#abb2bf>[</span><span style=color:#aa89ea>i</span><span style=color:#abb2bf>]];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10</span><span>  <span style=color:#aa89ea>obj</span><span style=color:#abb2bf>[</span><span style=color:#98c379>&#39;_&#39;</span> <span style=color:#54b1c7>+</span> <span style=color:#aa89ea>keys</span><span style=color:#abb2bf>[</span><span style=color:#aa89ea>i</span><span style=color:#abb2bf>]]</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>v</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11</span><span>  <span style=color:#e5c07b>Object</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>defineProperty</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>obj</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>keys</span><span style=color:#abb2bf>[</span><span style=color:#aa89ea>i</span><span style=color:#abb2bf>],</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12</span><span>    <span style=color:#aa89ea>get</span><span style=color:#54b1c7>:</span> <span style=color:#abb2bf>()</span> <span style=color:#abb2bf>=&gt;</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13</span><span>      <span style=color:#76a9f9>return</span> <span style=color:#76a9f9>this</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>_inner</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14</span><span>    <span style=color:#abb2bf>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15</span><span>    <span style=color:#aa89ea>set</span><span style=color:#54b1c7>:</span> <span style=color:#abb2bf>(</span><span style=color:#aa89ea>newV</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>=&gt;</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16</span><span>      <span style=color:#76a9f9>this</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>_inner</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>newV</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17</span><span>    <span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18</span><span><span style=color:#abb2bf>})</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19</span><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><h3 id=vue用objectdefinedpropoty实现响应式系统存在的问题>Vue用<code>Object.definedPropoty()</code>实现响应式系统存在的问题</h3><blockquote><p><code>Object.definedPropoty()</code>方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。</p></blockquote><p>这个方法只能操作JS对象里的属性，对其修改或创建。同样的，我们也只能将其已定义的属性转化为上文提到的<code>getter/setter</code>。</p><p>换句话说，我们只能观测已定义的属性的改变，无法观测到JS对象里是否添加或删除里某个属性。这一点也在Vue的文档中提到了。
并且也给出了<a href=https://cn.vuejs.org/v2/guide/reactivity.html>解决方案</a>。所以Vue也建议开发者将需要用到的属性预先定义在<code>data</code>选项中，
即使是先将值定义为空。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/vue>Vue</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/siaikin rel=me title=Github><i data-feather=github></i></a>
<a class=border></a><a class=soc href=abc1310054026@outlook.com rel=me title=Email><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=/index.xml rel=me title=RSS><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>